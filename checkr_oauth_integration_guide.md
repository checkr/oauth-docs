# Checkr oAuth Integration Guide

With Checkr oAuth, your customers can easily connect their Checkr account with your application.

OAuth 2 is a protocol that lets you have access to Checkr account's data that have authorized your application, without knowing their API key or password.
Before getting started, please email clients@checkr.com to register your application.

Every Checkr partner will have its own OAuth application associated with a unique `client_id` and `client_secret` which will be used in the OAuth flow. The `client_secret` must not be shared.
The `client_secret` should not be shared.

## 1. Flow
When a user wants to connect their Checkr account to your platform, they’ll go through these steps:

1. On your website, the user will click a link that takes them to Checkr, passing along your application `client_id`.
2. Once on Checkr’s website, the user will be prompted to authorize your application by either:
    - Creating a new account with a credit card
    - Login into their existing account
    - If they are already connected, simply authorizing the application
3. The user will then be redirected back to your site (specifically to your `redirect_uri`), passing along an authorization `code`.
4. Using this `code`, your website will be able to create an `access_token` for this account and store it on your data store.
5. Subsquent API requests can be made on behalf of the authorized account using the token.

## 2. Integrating

To get started with your integration, you’ll first need to know two key pieces of information from in your platform settings:

- Your `client_id`, a unique identifier for your platform, generated by Checkr.
- Your `redirect_uri`, a page on your website to which the user will be redirected after connecting their account (or failing to, should that be the case), set by you.
Checkr can also provide a development `client_id`, to make testing easier.

### 2.1 User authorization

With these two pieces of information in hand, you’re ready to have your users connect with your platform. We recommend showing a Connect button that sends them to our authorize_url endpoint:

```
https://checkr.com/oauth/authorize/:client_id?scope=read_write
```

To prevent CSRF attacks, you can use the `state` parameter, passing along a unique token as the value. We’ll include the `state` you gave us when we redirect back.

Here is how this may look (the href value matches that above):

![Connect with Checkr](https://checkr.com/assets/images/connect_with_checkr.png)


### 2.2 Token issuance

When the user arrives at Checkr, they’ll be prompted to allow or deny the connection to your platform, and will then be sent to your `redirect_uri` page. In the URL, we’ll pass along an authorization code:

```
https://YOUR-REDIRECT-URI.com/checkr?scope=read_write&code=AUTHORIZATION_CODE
```

Using the `code` parameter, you should make a POST request to our `token` endpoint:

```curl
curl -X POST https://api.checkr.com/oauth/tokens \
    -d client_id=YOUR_CLIENT_ID \
    -d client_secret=YOUR_CLIENT_SECRET \
    -d code=AUTHORIZATION_CODE
```

Note that you’ll make the request with your live secret API key or test secret API key, depending on whether you want to get a live or test access token back.

Checkr will return a response containing the authentication credentials for the user:

```json
{
  "access_token": "xoxt-23984754863-2348975623103",
  "scope": "read_write",
  "checkr_account_id": "XXXX"
}
```

You’re done!  The user has now authorized your platform.  You’ll want to store all of the returned information in your database for later use.

### 2.3. Additional per-account configuration steps
#### 2.3.1 Webhooks
You may want to start listening Webhooks events (eg: `report.completed`) for your authorized accounts.
To do so, you will need to manage Webhooks for every account: see [Webhooks API documentation](https://gist.github.com/jperichon/5c2ac76e779fd596ed70).

#### 2.3.2 Packages
You may want to have a dynamic way of creating and listing report's packages on a per-account basis.

To do so, you will need to manage Packages of every authorized account: see [Packages API documentation](https://gist.github.com/jperichon/4a01e9266cada5af677e).

### 2.4 User deauthorization

#### 2.4.1 From Checkr's dashboard
A `token.deauthorized` webhook event is sent when a user disconnects your platform from their account. By watching for this event, you can perform any necessary credential cleanup on your servers. (Note that a managed account cannot be disconnected by the account’s beneficiary.)

#### 2.4.2 From your system

Additionally, if you want to disconnect access to an account, you can POST to `https://checkr.com/oauth/deauthorize`:

```curl
curl https://checkr.com/oauth/deauthorize \
   -u YOUR_SECRET_KEY:
```

## 3. Sample application in Ruby

```ruby
require 'sinatra'
require 'oauth2'

configure do
  set :client_id, 'YOUR_CLIENT_ID'
  set :client_secret, 'YOUR_CLIENT_SECRET'

  set :options, {
    site: 'https://checkr.com',
    authorize_url: "/oauth/authorize/#{settings.client_id}",
    token_url: '/oauth/tokens'
  }

  set :client, OAuth2::Client.new(settings.client_id, settings.client_secret, settings.options)
end

get '/' do
  <<-END
    <a href="#{settings.options[:site]}#{settings.options[:authorize_url]}">
      <img src="https://checkr.com/assets/images/connect_with_checkr.png" width="250" />
    </a>
  END
end

get '/oauth_callback' do
  code = params[:code]

  response = settings.client.auth_code.get_token(code, params: { scope: 'read_write' })
  access_token = response.token
  
  # you can now store this token and use it as a regular Checkr API key
end
```

## [4. Checkr oAuth Full Reference](https://gist.github.com/jperichon/348ff7e99158d075cbc7)
